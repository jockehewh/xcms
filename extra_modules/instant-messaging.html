<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <script src="/instant-messaging-scripts/socket.io.js"></script>
  <style>
    *{margin:0; padding:0}
    body{
      height:100vh;
      display:flex;
    }
    .main{
      width:85%
    }
    .firstname-edit input, .lastname-edit input{
      border:none;
      line-height: 2;
    }
    .received-private-messages, .received-public-messages, .write-public-message, .write-private-message{
      width: 80%;
    }
    .received-private-messages, .received-public-messages{
      min-height:80%;
      overflow-y: scroll;
    }
    .received-private-messages::-webkit-scrollbar, .received-public-messages::-webkit-scrollbar{
      width:0;
    }
    .innerlink{
      height:100%;
      display: none;
    }
    .menu{
      width:15%;
    }
    ul{
      list-style: none;
    }
    button{
      border: none;
      background: transparent;
      cursor:pointer;
    }
    textarea{
      width:90%;
      resize:none;
    }
  </style>
</head>
<body>
  <!--
    un onglet profile
    un onglet messagerie public
    un onglet messagerie privÃ©
  -->
  <div class="main">
    <div class="profile innerlink" data-link="profile">
      <div class="have-profile">
        <h1><span></span>' profile</h1>
        <img src="" alt="profile-pic">
        <p class="lastname">Last name: <span></span></p>
        <p class="firstname">First name: <span></span></p>
        <a href="#">Edit your profile</a>
        <h3>Contacts</h3>
        <ul class="contacts-list">

        </ul>
      </div>
      <div class="have-noprofile">
        <h1>Edit your profile</h1>
        <img src="" alt="profile-pic">
        <p class="lastname-edit">Last name: <span><input type="text" placeholder="your name here"></span></p>
        <p class="firstname-edit">First name: <span><input type="text" placeholder="your name here"></span></p>
        <button>Save changes</button>
      </div>
    </div><!--FIN DE LA SECTION profile-->
    <div class="public-messages innerlink" data-link="public-messages">
      <div class="received-public-messages"></div>
      <div class="write-public-message">
        <textarea name="message-public" id="message-public" cols="30" rows="10"></textarea>
        <button>Send</button>
      </div>
    </div><!--FIN DE LA SECTION PUBLIC MESSAGES-->
    <div class="private-messages innerlink" data-link="private-messages">
      <div class="received-private-messages"><!--Changes its content with the current active contact--></div>
      <div class="write-private-message">
        <textarea name="message-private" id="message-private" cols="30" rows="10"></textarea>
        <button>Send</button>
      </div>
    </div><!--FIN DE LA SECTION PRIVATE MESSAGES-->
  </div>
  <div class="menu">
    <ul>
      <li><a href="#" data-link="profile">Profile</a></li>
      <li><a href="#" data-link="public-messages">Public messages</a></li>
      <li><a href="#" data-link="private-messages">Private messages</a></li>
    </ul>
  </div>
  <script>
    document.querySelector('.profile').style.display = "block"
    document.querySelectorAll('.menu a').forEach(link=>{
      link.addEventListener('click', (e)=>{
        let clickedLink = e.target.dataset.link
        document.querySelectorAll('.innerlink').forEach(innerlink =>{
          if(innerlink.dataset.link === clickedLink){
            innerlink.style.display = 'block'
          }else{
            innerlink.style.display = 'none'
          }
        })
      })
    })
    function editProfile(reedit = 0){
      let haveProfile = document.querySelector('.have-profile')
      let haveNoProfile = document.querySelector('.have-noprofile')
      haveProfile.style.display = "none"
      haveNoProfile.style.display = "block"
      haveNoProfile.querySelector('button').addEventListener('click', e=>{
        let firstname = document.querySelector('.firstname-edit input')
        let lastname = document.querySelector('.lastname-edit input')
        let picurl = document.querySelector('.have-noprofile img')
        if(firstname.value !== '' && lastname.value !== ''){
          localStorage.user = JSON.stringify({
          firstName: firstname.value,
          lastName: lastname.value,
          photourl: picurl.src
          })
          haveProfile.style.display = "block"
          document.querySelector('.have-profile h1 span').innerText = firstname.value
          document.querySelector('.firstname').innerText = firstname.value
          document.querySelector('.lastname').innerText = lastname.value
          window.user = firstname.value+' '+lastname.value
          haveNoProfile.style.display = "none"
          haveProfile.querySelector('a').addEventListener('click', ()=>{
            editProfile()
          })
          haveProfile.querySelector('img').src = picurl.src
        }else{
          alert('your firstname and last name are required')
        }
      })
    }
    if(!localStorage.user){
      editProfile()
    }else{
      let user = JSON.parse(localStorage.user)
      window.user = user.firstName+' '+user.lastName
      document.querySelector('.have-profile h1 span').innerText = user.firstName
      document.querySelector('.firstname').innerText = user.firstName
      document.querySelector('.lastname').innerText = user.lastName
      document.querySelector('.have-noprofile').style.display = 'none'
      document.querySelector('.have-profile a').addEventListener('click', ()=>{
            editProfile()
          })
      if(localStorage.contacts){
        window.contacts = JSON.parse(localStorage.contacts)
        if(window.contacts.length > 0){
          window.contacts.forEach(contact =>{
            let li = document.createElement('li')
            let contactName = document.createElement('p')
            contactName.innerText = contact
            li.appendChild(contactName)
            document.querySelector('.have-profile ul').appendChild(li)
          })
        }
      }else{
        window.contacts = []
        localStorage.contacts = JSON.stringify(window.contacts)
      }
    }
    if(window.user){
      const instantMessaging = io('/instant-messaging', {query: `name=${window.user}`})
      function isEmpty(text){
        checkEmpty = text.split('\n').join('').split(' ').join('')
        if(checkEmpty === ""){
          return true
        }else{
          return false
        }
      }
      document.querySelector('.public-messages button').addEventListener('click', (e)=>{
        if(isEmpty(document.querySelector('#message-public').value)){
          return
        }else{
          let publicMessage = {
            sender: window.user,
            message: document.querySelector('#message-public').value,
            timestamp: Date.now()
          }
          instantMessaging.emit('public-message', JSON.stringify(publicMessage))
        }
      })
      document.querySelector('.private-messages button').addEventListener('click', (e)=>{
        //liste de contact
      })
      instantMessaging.on('pubmsg', data=>{
        let msginfo = JSON.parse(data)
        console.log('new message:', msginfo)
        if(!window.contacts.includes(msginfo.sender) && msginfo.sender !== window.user){
          window.contacts.push(msginfo.sender)
          localStorage.contacts = JSON.stringify(window.contacts)
        }
        let div = document.querySelector('.received-public-messages')
        let msgbox = document.createElement('div')
        let h4 = document.createElement('h4')
        let text = document.createElement('p')
        h4.innerText = msginfo.sender+':'
        h4.style.textDecoration = 'underline'
        text.innerText = msginfo.message
        msgbox.appendChild(h4)
        msgbox.appendChild(text)
        div.appendChild(msgbox)
      })
    }
    //const instantMessaging = io('/instant-messaging', {query: "name=user"})
    /* 
public message = {
  sender: "",
  message: "",
  timestamp: ""
}
private message = {
  sender: "",
  receipient: "",
  message: "",
  timestamp: ""
}
set profile = {
  firstname: "",
  lastname: "",
  photo: "?"
}
 */
  </script>
</body>
</html>