<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Creative side</title>
    <link rel="stylesheet" href="./admin-site/xcms.css">
    <link rel="stylesheet" href="./admin-site/tachyons.min.css">
</head>
<body>
    <div class="genesis-pop">
        <!--Master titre maker-->
        <div id="options-select">
            <ul>
                <li><a href="#" data-size="3">moyen (h3)</a></li>
                <li><a href="#" data-size="4">casi cormal (h4)</a></li>
                <li><a href="#" data-size="2">grand (h2)</a></li>
                <li><a href="#" data-size="1">tres grand (h1)</a></li>
            </ul>
        </div>
    </div>
    <div class="genesis-popd">
        <!--Master menu maker-->
            <div id="options-selectd">
                <ul>
                    <li><a href="#" data-size="5">5 options</a></li>
                    <li><a href="#" data-size="4">4 options</a></li>
                    <li><a href="#" data-size="3">3 options</a></li>
                    <li><a href="#" data-size="2">2 options</a></li>
                </ul>
            </div>
        </div>
    <main class="mw-100 center">
        <div class="first-class fl ph3 pv5 w-70">
            <!--Master page maker-->
            <input type="file" accept="image" id="imgpiker">
            <div class="edit-zone" style="display:block;">
                <link rel="stylesheet" href="./admin-site/onepage.css">
                <link rel="stylesheet" href="./admin-site/multipage.css">
                <style scoped>
                    *{margin:0; padding:0; user-select: none;
                        --rouge-brick-pale: #ef5350;
                        --rouge-brique-eclatant: #ff5252;
                        --bleu-indigo-leger: #5c6bc0;
                        --bleu-indigo-eclatant: #536dfe;
                        --orange-pale: #e64a19;
                        --bleu-gris-clair: #cfd8dc;
                        --teal-bleu-special: #1de9b6;
                    }
                    .genesis-div, .genesis-img, .genesis-menu, .genesis-p, .genesis-titre{padding: 10px}
                    .genesis-menu{
                    list-style-type: none;
                    color: black;
                    }
                    .genesis-menu li{
                        display: inline;
                        margin: 5%;
                    }
                    .genesis-header{
                        min-height: 50px;
                    }
                    .genesis-div{
                        width:100%;
                        display:block;
                    }
                    .genesis-img{
                        display:block;
                        height: 250px;
                        width: 350px;
                    }
                    .genesis-p{
                        display:block;
                    }
                    .genesis-titre{
                        display:block;
                        color: var(--orange-pale)
                    }
                    .nav-menu{
                        display: flex;
                        flex-direction: row;
                        justify-content: space-between;
                        align-items: center;
                    }
                    .nav-item{
                        list-style-type: none;
                        text-transform: uppercase;
                    }
                </style>
                <nav><ul class="nav-menu">

                </ul></nav>
            </div>
            <div class="maFrame">
                
            </div>
        </div>
        <div class="first-class-editor fl pa2 w-30">
            <section>
                <p><span>editor</span> - <span>designer</span></p>
                <label class="switch">
                <input class="changemod" type="checkbox">
                <span class="slider"></span>
            </label>
            </section>
            <section id="designmaker">
                <label for="font-selector">Change font</label>
                <select name="font-selector" id="font-selector">
                    <option value="Avenir Next">Avenir Next</option>
                    <option value="Helvetica">Helvetica</option>
                    <option value="San Francisco">San Francisco</option>
                    <option value="Roboto">Roboto</option>
                    <option value="System Sans-Sherif">System Sans-Sherif</option>
                    <option value="Athelas">Athelas</option>
                    <option value="Baskerville">Baskerville</option>
                    <option value="Garamond">Garamond</option>
                    <option value="Georgia">Georgia</option>
                    <option value="System Sherif">System Sherif</option>
                </select>
                <button class="linemaker">one line container</button>
            </section>
            <section id="nodemaker" class="mt5 tc">
                <label><input type="radio" id="designer" name="designer" value="single" checked> Site une page </label><br>
                <label><input type="radio" id="designer" name="designer" value="multiple"> Site multipage </label><br>
                <input id="titrepage" type="text" placeholder="nom de la nouvelle page">
                <ul class="list">
                    <li class="b--light-silver br3 br--top bg-animate black hover-bg-dark-gray hover-blue ph3 pv1-ns w-100"><a class="black hover-blue link ph5" href="#" data-demande="header">header</a></li>
                    <li class="b--light-silver br3 br--top bg-animate black hover-bg-dark-gray hover-blue ph3 pv1-ns w-100"><a class="black hover-blue link ph5" href="#" data-demande="footer">footer</a></li>
                    <li class="b--light-silver br3 br--top bg-animate black hover-bg-dark-gray hover-blue ph3 pv1-ns w-100"><a class="black hover-blue link ph5" href="#" data-demande="div">section</a></li>
                    <li class="b--light-silver br3 br--top bg-animate black hover-bg-dark-gray hover-blue ph3 pv1-ns w-100"><a class="black hover-blue link ph5" href="#" data-demande="menu">menu</a></li>
                    <li class="b--light-silver br3 br--top bg-animate black hover-bg-dark-gray hover-blue ph3 pv1-ns w-100"><a class="black hover-blue link ph5" href="#" data-demande="texte">texte</a></li>
                    <li class="b--light-silver br3 br--top bg-animate black hover-bg-dark-gray hover-blue ph3 pv1-ns w-100"><a class="black hover-blue link ph5" href="#" data-demande="image">image</a></li>
                    <li class="b--light-silver br3 br--top bg-animate black hover-bg-dark-gray hover-blue ph3 pv1-ns w-100"><a class="black hover-blue link ph5" href="#" data-demande="titre">titre</a></li>
                    <li class="b--light-silver br3 br--top bg-animate black hover-bg-dark-gray hover-blue ph3 pv1-ns w-100"><a class="black hover-blue link ph5" href="#" data-demande="video">video</a></li>
                </ul>
                <div class="colors">
                    <label id="fond">
                        <input type="radio" id="colorbox" name="color" value='back'> Couleur de fond: <br>
                    </label>
                    <label id="texte">
                            <input type="radio" id="colorbox" name="color" value='text'> Couleur du text: <br>
                        </label>
                    <input type="color" name="color-picker" id="color-picker">
                </div>
                <div>
                    légende: 
                    <p style="border: solid red 3px">va être éditer</p>
                    <p style="border: solid orange 3px">contiendra le prochain élément</p>
                </div>
            </section>
            <section class="boutons">
                <button id="crepage">VALIDER</button>
                <button id="crenew">Creer page</button>
                <button id="efface">EFFACER</button>
            </section>
            <!--<section>
                <textarea name="contenuText" id="contenuCouleur" cols="30" rows="10"></textarea>
                <a data-demande="hypertxt">apply</a>
            </section>-->
            <section>
                <p>edit an old page</p>
                <ul class="editables list">
                    
                </ul>
            </section>
        </div>
    </main>
<script>
        /* 
            CONNEXION EN WEBSOCKET 0 REFERMER
        */
        var mews = new WebSocket('ws://localhost:9898');
        var crepage = document.querySelector('#crepage');
        var jss = JSON.stringify
        var jsp = JSON.parse
        const pushToDom = document.querySelector('.edit-zone').appendChild
        var titre, contenu, nouvellepage;
        var imgpicker = document.querySelector('#imgpiker');
        let editablePages =[]
        mews.onopen = ()=>{
            console.log('connected')
            crepage.addEventListener('click', e =>{
                var imgs = document.querySelectorAll('img');
                    console.log(imgs[0])
                    var i = 0
                while ( i<= imgs.length-1){
                    console.log(imgs[i])
                    imgs[i].src = './imgs/'+titresImgs[i];
                    i++
                }
                document.querySelector('.edit-zone').querySelectorAll('link').forEach(link=>{
                    link.remove()
                })
                var j = 1
                while (j <= 6){
                    if(document.querySelectorAll('h'+j) !== 0){
                        document.querySelectorAll('h'+j).forEach(title=>{
                            title.removeAttribute('contenteditable')
                        })
                    }
                    j++
                }
                if(document.querySelectorAll('p').length !== 0){
                    document.querySelectorAll('p').forEach(text=>{
                        text.removeAttribute('contenteditable')
                    })
                }
                e.preventDefault();
                titre = document.querySelector('#titrepage').value;
                contenu = `<!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <meta http-equiv="X-UA-Compatible" content="ie=edge">
                    <title>${titre}</title>
                    <link rel="stylesheet" href="./client-site/tachyons.min.css">
                    <script src='./client-site/designer.js'><\/script>
                    </head><body>${document.querySelector('.edit-zone').innerHTML}</body></html>`;
                if(titre === "" || titre === undefined){
                    titre = prompt("comment s'appelera la page que vous souhaitez envoyé")
                }
                nouvellepage = {titre, contenu}
                mews.send(jss(nouvellepage))
                var allnodes = document.querySelector('.edit-zone').childNodes
                var j = allnodes.length
                while( j>2 ){
                    document.querySelector('.edit-zone').lastChild.remove()
                    j--
                }
            }, false)
        }

        mews.onmessage = (data)=>{
            parsed = jsp(data.data)
            if(parsed.lien && parsed.lien !== ""){
                if( editablePages != undefined && editablePages.includes(parsed.lien)){
                    return
                }else{
                    editablePages.push({...parsed.lien, index: editablePages.length})
                    var li = document.createElement('li');
                    var a = document.createElement('a');
                    a.href = '#'
                    a.innerText = parsed.lien.name
                    a.dataset.index = editablePages.length - 1
                    a.className += "black hover-blue link ph5"
                    li.appendChild(a);
                    li.className += "b--light-silver br3 br--top bg-animate black hover-bg-dark-gray hover-blue ph3 pv1-ns w-100"
                    //EDITION DES PAGES
                    a.addEventListener('click', (e)=>{
                        e.preventDefault();
                        myframe = document.querySelector('.maFrame')
                        var theframe = document.createElement('div')
                        theframe.classList.add('re-edit-zone')
                        theframe.innerHTML = editablePages[e.target.dataset.index].page
                        myframe.appendChild(theframe)
                        document.querySelector('.edit-zone').style.display = 'none'
                        //PREPARATION AU CHANGEMENT
                        theframe.childNodes.forEach(node=>{
                            if(node instanceof HTMLElement){
                                if(node.hasAttribute('class')){
                                    if(node.className !== "genesis-img"){
                                    node.setAttribute('contenteditable', true)
                                    }
                                }
                            }
                        })
                        document.querySelector('.re-edit-zone').addEventListener('click', function(e){
                            e.preventDefault();
                            e.stopImmediatePropagation();
                            if(e.target.getAttribute('contenteditable') === "false" || e.target.getAttribute('contenteditable') === null){
                                if(e.target.id === "isActive"){
                                    e.target.id = ""
                                }else{
                                    e.target.id = "isActive"
                                }
                            }else if(e.target.getAttribute('contenteditable') === "true"){
                                return
                            }
                        }, false)
                        document.querySelector('.re-edit-zone').addEventListener('dblclick', function(e){
                            e.preventDefault();
                            e.stopPropagation();
                            if(e.target.id === "isContainer"){
                                e.target.id = ""
                            }else{
                                e.target.id = "isContainer"
                            }
                        })
                        //ENREGISTREMENT DES CHANGEMENTS
                        let button = document.createElement('button')
                        button.innerText = 'Enregistrer et fermer'
                        document.querySelector('.boutons').appendChild(button)
                        button.addEventListener('click', ev=>{
                            //MODIFIER LES LIENS
                            var imgs = document.querySelectorAll('img');
                                var i = j = 0
                            while ( i<= imgs.length-1){
                                if(/\/imgs\//.test(imgs[i].src)){
                                    i++
                                }else{
                                    imgs[i].src = './imgs/'+titresImgs[j];
                                    i++
                                    j++
                                }
                            }
                            //ENLEVER ATTRIBUT CONTENTEDITABLE
                            theframe.childNodes.forEach(node=>{
                                if(node instanceof HTMLElement){
                                    if(node.hasAttribute('class')){
                                        if(node.className !== "genesis-img"){
                                        node.removeAttribute('contenteditable')
                                        }
                                    }
                                }
                            })
                            if(document.querySelectorAll('p').length !== 0){
                                document.querySelectorAll('p').forEach(text=>{
                                    text.removeAttribute('contenteditable')
                                })
                            }
                            let name = e.target.innerText
                            let page = `<!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <meta http-equiv="X-UA-Compatible" content="ie=edge">
                    <title>${e.target.innerText}</title>
                    <link rel="stylesheet" href="./client-site/tachyons.min.css">
                    <script src='./client-site/designer.js'><\/script>
                    </head><body>${theframe.innerHTML}</body></html>`;
                            let changedPage = {name, page}
                            mews.send(jss({update: changedPage}))
                            editablePages[e.target.dataset.index].page = theframe.innerHTML
                            theframe.remove()
                            document.querySelector('.edit-zone').style.display = 'block'
                            button.remove()
                        })
                    }, false)
                }
                document.querySelector('.editables').appendChild(li)
                li = a = ""
            }
        }
        /* 
        CREATION DEZS ELEMENTS
        */
        /* 
            elements creation
        */
       var titresImgs = []
       var pushCount = 0
        document.querySelectorAll('.first-class-editor a').forEach((btn)=>{
            btn.addEventListener('click', (e)=>{
                e.preventDefault();
                e.stopPropagation();
                switch(e.target.dataset.demande){
                    case 'header':
                    desactive()
                        var header = document.createElement('header')
                        header.id = 'isActive isContainer'
                        header.classList.add('genesis-header')
                        header.innerText = prompt('Valeur du titre:')
                        xAppend(header)
                    break;
                    case 'footer':
                    desactive()
                        var footer = document.createElement('footer')
                        footer.id = 'isActive isContainer'
                        footer.classList.add('genesis-footer')
                        xAppend(footer)
                    break;
                    case 'div':
                    desactive()
                        var div = document.createElement('div')
                        div.id = 'isActive isContainer'
                        div.classList.add('genesis-div')
                        xAppend(div)
                    break;
                    case 'image':
                    desactive()
                        var imgpicker = document.querySelector('#imgpiker');
                        var img = document.createElement('img');
                        img.id ='isActive'
                        img.classList.add('genesis-img')
                        xAppend(img)
                        imgpicker.style.display = 'block'
                        var imgpicklone = document.createElement('input');
                            imgpicklone.setAttribute('type', 'file')
                            imgpicklone.setAttribute('accept', 'image')
                            imgpicklone.id = 'imgpiker'
                            imgpicklone.style.display = 'none'
                            imgpicker.addEventListener('change', function(ev){
                                ev.stopPropagation()
                                pushCount++
                                var type = {type: imgpicker.files[0].type}
                                var file0 = imgpicker.files[0];
                                titresImgs.push(file0.name)
                                imgpicker.replaceWith(imgpicklone);
                                mews.send(jss({name: file0.name, type: type.type}))
                                mews.send(file0)
                                img.src = window.URL.createObjectURL(file0)
                                img.onload = function(eve){
                                window.URL.revokeObjectURL(this.src)
                                img = ""
                                imgpicker.style.display = 'none'
                                }
                            },false)
                            

                    break;
                    case 'texte':
                    desactive()
                        var pé = document.createElement('p');
                        pé.id = "isActive"
                        pé.classList.add('genesis-p')
                        pé.setAttribute('contenteditable', true)
                        xAppend(pé)
                        pé.addEventListener('keydown', e=>{
                            if(e.code === 'Enter' || e.code === 'NumpadEnter'){
                                e.preventDefault();
                                document.execCommand('insertHTML', false, '<br><br>')
                                return false
                            }
                            //if echap enlever la class isActive
                        })
                    break;
                    case 'titre':
                    desactive()
                    var headerVal;
                        document.querySelector('.genesis-pop').style.display = 'flex'
                        document.querySelectorAll('#options-select a').forEach(as =>{
                            //defini la grandeur du Titre
                                as.addEventListener('click', e =>{
                                    e.stopImmediatePropagation()
                                    headerVal = e.target.dataset.size
                                    var titre = document.createElement(`h${headerVal}`)
                                    titre.id = "isActive"
                                    titre.setAttribute('contenteditable', true)
                                    titre.innerText = "Cliquer ici pour éditer le titre"
                                    titre.classList.add('genesis-titre');
                                    xAppend(titre)
                                    titre.focus()
                                    document.querySelector('.genesis-pop').style.display = 'none'
                                    titre.onblur = e=>{
                                        titre.id = ""
                                        if(e.target.hasAttribute('lien')){
                                            return
                                        }else{
                                            var lien = e.target.innerText
                                            var lienoulien = confirm(e.target.innerText+ ' sera-t-il la cible d\'un lien?')
                                            if(lienoulien === true){
                                                titre.setAttribute('lien', true)
                                                titre.classList.add('lien')
                                            }else{
                                                titre.setAttribute('lien', false)
                                            }
                                        }
                                        
                                    }
                                    titre.addEventListener('keydown', e=>{
                                        if(e.code === 'Enter' || e.code === 'NumpadEnter'){
                                            titre.blur()
                                            e.preventDefault();
                                            return false
                                        }
                                    })
                                })
                            })
                    break;
                    case 'video':

                    break;
                    case 'menu':
                    desactive()
                    var menuSize;
                        document.querySelector('.genesis-popd').style.display = 'flex'
                        document.querySelectorAll('#options-selectd a').forEach(as =>{
                            //defini la longueur du menu
                            /* 
                                documenter : sequence de création et l'édition 
                                double click pour éditer une section
                            */
                                as.addEventListener('click', e =>{
                                    e.stopImmediatePropagation()
                                    var ul = document.createElement('ul');
                                    menuSize = 0
                                    while(menuSize < Number(e.target.dataset.size)){
                                        var li = document.createElement('li');
                                        var alink = document.createElement('a');
                                        var titrelien = prompt("choisissez la direction du lien n°"+(menuSize+1)+"/"+Number(e.target.dataset.size)+":")
                                        alink.href = "#" + titrelien
                                        alink.innerText = titrelien
                                        alink.id = "isActive"
                                        li.appendChild(alink);
                                        ul.appendChild(li);
                                        ul.classList.add('genesis-menu')
                                        alink.id = ""
                                        menuSize++
                                    }
                                    menuSize = 0
                                    xAppend(ul)
                                    document.querySelector('.genesis-popd').style.display = 'none'
                                })
                            })
                    break;
                    case 'hypertxt':
                    //BLOCK A REVOIR
                            var isActive = document.querySelector('#isActive')
                            isActive.innerHTML = document.querySelector('textarea').value
                            isActive.id = ""
                            isActive = ""
                            document.querySelector('textarea').value = ""
                    break;
                }
                
            }, false)
        })
            //***************LIVE ON PAGE LIVE
        document.querySelector('.edit-zone').addEventListener('click', function(e){
            e.preventDefault();
            e.stopImmediatePropagation();
            if(e.target.getAttribute('contenteditable') === "false" || e.target.getAttribute('contenteditable') === null){
                if(e.target.id === "isActive"){
                    e.target.id = ""
                }else{
                    e.target.id = "isActive"
                }
            }else if(e.target.getAttribute('contenteditable') === "true"){
                return
            }
        }, false)
        document.querySelector('.edit-zone').addEventListener('dblclick', function(e){
            e.preventDefault();
            e.stopPropagation();
            if(e.target.id === "isContainer"){
                e.target.id = ""
            }else{
                e.target.id = "isContainer"
            }
        })
        //******************CREATION DE PAGE
        document.querySelector('#crenew').addEventListener('click', (e)=>{
            e.preventDefault();
            document.querySelector('.edit-zone').innerHTML = ""
            //IFRAME PLUS UTILISEE
            document.querySelector('iframe').remove()
            document.querySelector('.edit-zone').style.display = "block"
        })
        //*****************RESET
        document.querySelector('#efface').addEventListener('click', e=>{
            var allnodes = document.querySelector('.edit-zone').childNodes
                var j = allnodes.length
                while( j>2 ){
                    document.querySelector('.edit-zone').lastChild.remove()
                    j--
                }
        })
        //******************APPEND
        function xAppend(item){
            if(document.querySelector('#isContainer') !== null){
                document.querySelector('#isContainer').appendChild(item)
                document.querySelector('#isContainer').classList.add('not-empty-container')
            }else{
                if(document.querySelector('.edit-zone').style.display === "block"){
                    document.querySelector('.edit-zone').appendChild(item)
                }else{
                    document.querySelector('.re-edit-zone').appendChild(item)
                }
            }
        }
        //*************DEACTIVR
        function desactive(){
            document.querySelectorAll('#isActive').forEach(active =>{active.id = ''})
        }
</script>
<script>
    // AFFICHAGE
    var singlecss = document.styleSheets[1].cssRules
    var multiplecss = document.styleSheets[2].cssRules
    document.querySelectorAll('#designer').forEach(designer =>{
        designer.addEventListener('change', e=>{
            var i =0
            console.log(e.target)
            if(e.target.value === 'single'){
                var styleEmbarque = document.querySelector('.edit-zone style')
                styleEmbarque.innerText = ''
                while (i < document.styleSheets[1].cssRules.length){
                    styleEmbarque.innerText += singlecss[i].cssText
                    i++
                }
            }
            if(e.target.value === 'multiple'){
                var styleEmbarque = document.querySelector('.edit-zone style')
                styleEmbarque.innerText = ''
                while (i < document.styleSheets[2].cssRules.length){
                    styleEmbarque.innerText += multiplecss[i].cssText
                    i++
                }
            }
        })
    })
    document.querySelector('#color-picker').addEventListener('change', (e)=>{
        console.log(e.target.value)
        document.querySelectorAll('#colorbox').forEach(colorBox=>{
            if(colorBox.checked && colorBox.value === "back"){
                if(document.querySelector('#isActive') !== null){
                    document.querySelector('#isActive').style.backgroundColor = e.target.value
                }
                if(document.querySelector('#isContainer') !== null){
                    document.querySelector('#isContainer').style.backgroundColor = e.target.value
                }
            }
            if(colorBox.checked && colorBox.value === "text"){
                if(document.querySelector('#isActive') !== null){
                    document.querySelector('#isActive').style.color = e.target.value
                }
                if(document.querySelector('#isContainer') !== null){
                    document.querySelector('#isContainer').style.color = e.target.value
                }
            }
        })
    })
    document.querySelector('.changemod').addEventListener('change', (e)=>{
        if(document.querySelector('.changemod').checked){
            document.querySelector('#designmaker').style.display = "block"
            document.querySelector('#nodemaker').style.display = "none"
            document.querySelector('.linemaker').addEventListener('click', e=>{
                document.querySelector('#isActive').className += " flex flex-column flex-row-ns"
            })
        }else{
            document.querySelector('#designmaker').style.display = "none"
            document.querySelector('#nodemaker').style.display = "block"
        }
    })
</script>
</body>
</html>